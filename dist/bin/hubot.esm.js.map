{"version":3,"file":"hubot.esm.js","sources":["../../bin/hubot.ts"],"sourcesContent":["#!/usr/bin/env node --loader esm-loader-typescript\nimport * as fs from \"fs\"\nimport { resolve as pathResolve } from \"path\"\n\nimport optparse from \"optparse\"\n\nimport { loadBot } from \"../src\"\n\nconst { OptionParser } = optparse\n\nconst switches = [\n  [\"-a\", \"--adapter ADAPTER\", \"The Adapter to use\"],\n  [\"-c\", \"--create PATH\", \"Create a deployable hubot\"],\n  [\"-d\", \"--disable-httpd\", \"Disable the HTTP server\"],\n  [\"-h\", \"--help\", \"Display the help information\"],\n  [\"-l\", \"--alias ALIAS\", \"Enable replacing the robot's name with alias\"],\n  [\"-n\", \"--name NAME\", \"The name of the robot in chat\"],\n  [\"-r\", \"--require PATH\", \"Alternative scripts path\"],\n  [\n    \"-t\",\n    \"--config-check\",\n    \"Test hubot's config to make sure it won't fail at startup\",\n  ],\n  [\"-v\", \"--version\", \"Displays the version of hubot installed\"],\n] as const\n\nconst options = {\n  adapter: process.env.HUBOT_ADAPTER || \"shell\",\n  alias: process.env.HUBOT_ALIAS,\n  create: process.env.HUBOT_CREATE || false,\n  enableHttpd:\n    process.env.HUBOT_HTTPD !== undefined\n      ? [\"0\", \"false\"].includes(process.env.HUBOT_HTTPD.toLowerCase())\n      : true,\n  scripts: [] as string[],\n  name: process.env.HUBOT_NAME || \"Hubot\",\n  path: process.env.HUBOT_PATH || \".\",\n  configCheck: false,\n  version: undefined as boolean | undefined,\n}\n\nconst Parser = new OptionParser(switches)\nParser.banner = \"Usage hubot [options]\"\n\nParser.on(\"adapter\", (opt, value) => {\n  options.adapter = value\n})\n\nParser.on(\"create\", (opt, value) => {\n  options.path = value\n  options.create = true\n})\n\nParser.on(\"disable-httpd\", (opt) => {\n  options.enableHttpd = false\n})\n\nParser.on(\"help\", () => {\n  console.log(Parser.toString())\n  return process.exit(0)\n})\n\nParser.on(\"alias\", (opt, value) => {\n  if (!value) {\n    value = \"/\"\n  }\n  options.alias = value\n})\n\nParser.on(\"name\", (opt, value) => {\n  options.name = value\n})\n\nParser.on(\"require\", (opt, value) => {\n  options.scripts.push(value)\n})\n\nParser.on(\"config-check\", (opt) => {\n  options.configCheck = true\n})\n\nParser.on(\"version\", (opt, value) => {\n  options.version = true\n})\n\nParser.on((opt, value) => {\n  console.warn(`Unknown option: ${opt}`)\n})\n\nParser.parse(process.argv)\n\nif (process.platform !== \"win32\") {\n  process.on(\"SIGTERM\", () => process.exit(0))\n}\n\nif (options.create) {\n  console.error(\n    \"'hubot --create' is deprecated. Use the yeoman generator instead:\"\n  )\n  console.error(\"    npm install -g yo generator-hubot\")\n  console.error(`    mkdir -p ${options.path}`)\n  console.error(`    cd ${options.path}`)\n  console.error(\"    yo hubot\")\n  console.error(\n    \"See https://github.com/github/hubot/blob/master/docs/index.md for more details on getting started.\"\n  )\n  process.exit(1)\n}\n\nconst robot = loadBot(\n  undefined,\n  options.adapter,\n  options.enableHttpd,\n  options.name,\n  options.alias\n)\n\nif (options.version) {\n  console.log(robot.version)\n  process.exit(0)\n}\n\nif (options.configCheck) {\n  loadScripts()\n  console.log(\"OK\")\n  process.exit(0)\n}\n\nrobot.once(\"adapter-initialized\", () => robot.run())\nrobot.once(\"connected\", loadScripts)\n\nfunction loadExternalScripts() {\n  const externalScripts = pathResolve(\".\", \"external-scripts.json\")\n\n  if (!fs.existsSync(externalScripts)) {\n    return\n  }\n\n  fs.readFile(\n    externalScripts,\n    { encoding: \"utf8\" },\n    async (error, data: string) => {\n      if (error) {\n        throw error\n      }\n\n      try {\n        await robot.loadExternalScripts(JSON.parse(data))\n      } catch (loadingError) {\n        console.error(\n          `Error parsing JSON data from external-scripts.json: ${loadingError}`\n        )\n        process.exit(1)\n      }\n    }\n  )\n}\nfunction loadScripts() {\n  robot.load(pathResolve(\".\", \"scripts\"))\n  robot.load(pathResolve(\".\", \"src\", \"scripts\"))\n\n  loadExternalScripts()\n\n  options.scripts.forEach((scriptPath) => {\n    if (scriptPath[0] === \"/\") {\n      return robot.load(scriptPath)\n    }\n\n    robot.load(pathResolve(\".\", scriptPath))\n  })\n}\n"],"names":["OptionParser","optparse","switches","options","adapter","process","env","HUBOT_ADAPTER","alias","HUBOT_ALIAS","create","HUBOT_CREATE","enableHttpd","HUBOT_HTTPD","undefined","includes","toLowerCase","scripts","name","HUBOT_NAME","path","HUBOT_PATH","configCheck","version","Parser","banner","on","opt","value","console","log","toString","exit","push","warn","parse","argv","platform","error","robot","loadBot","loadScripts","once","run","loadExternalScripts","externalScripts","pathResolve","fs","existsSync","readFile","encoding","data","JSON","loadingError","load","forEach","scriptPath"],"mappings":";;;;;;;;;;;;;AAQA,MAAM;AAAEA,EAAAA,YAAAA;AAAc,CAAA,GAAGC,QAAQ,CAAA;AAEjC,MAAMC,QAAQ,GAAG,CACf,CAAC,IAAI,EAAE,mBAAmB,EAAE,oBAAoB,CAAC,EACjD,CAAC,IAAI,EAAE,eAAe,EAAE,2BAA2B,CAAC,EACpD,CAAC,IAAI,EAAE,iBAAiB,EAAE,yBAAyB,CAAC,EACpD,CAAC,IAAI,EAAE,QAAQ,EAAE,8BAA8B,CAAC,EAChD,CAAC,IAAI,EAAE,eAAe,EAAE,8CAA8C,CAAC,EACvE,CAAC,IAAI,EAAE,aAAa,EAAE,+BAA+B,CAAC,EACtD,CAAC,IAAI,EAAE,gBAAgB,EAAE,0BAA0B,CAAC,EACpD,CACE,IAAI,EACJ,gBAAgB,EAChB,2DAA2D,CAC5D,EACD,CAAC,IAAI,EAAE,WAAW,EAAE,yCAAyC,CAAC,CACtD,CAAA;AAEV,MAAMC,OAAO,GAAG;AACdC,EAAAA,OAAO,EAAEC,OAAO,CAACC,GAAG,CAACC,aAAa,IAAI,OAAO;AAC7CC,EAAAA,KAAK,EAAEH,OAAO,CAACC,GAAG,CAACG,WAAW;AAC9BC,EAAAA,MAAM,EAAEL,OAAO,CAACC,GAAG,CAACK,YAAY,IAAI,KAAK;EACzCC,WAAW,EACTP,OAAO,CAACC,GAAG,CAACO,WAAW,KAAKC,SAAS,gBACjC,CAAC,GAAG,EAAE,OAAO,CAAC,CAACC,QAAQ,eAACV,OAAO,CAACC,GAAG,CAACO,WAAW,CAACG,WAAW,EAAE,CAAC,GAC9D,IAAI;AACVC,EAAAA,OAAO,EAAE,EAAc;AACvBC,EAAAA,IAAI,EAAEb,OAAO,CAACC,GAAG,CAACa,UAAU,IAAI,OAAO;AACvCC,EAAAA,IAAI,EAAEf,OAAO,CAACC,GAAG,CAACe,UAAU,IAAI,GAAG;AACnCC,EAAAA,WAAW,EAAE,KAAK;AAClBC,EAAAA,OAAO,EAAET,SAAAA;CACV,CAAA;AAED,MAAMU,MAAM,gBAAG,IAAIxB,YAAY,CAACE,QAAQ,CAAC,CAAA;AACzCsB,MAAM,CAACC,MAAM,GAAG,uBAAuB,CAAA;AAEvCD,MAAM,CAACE,EAAE,CAAC,SAAS,EAAE,CAACC,GAAG,EAAEC,KAAK,KAAI;EAClCzB,OAAO,CAACC,OAAO,GAAGwB,KAAK,CAAA;AACzB,CAAC,CAAC,CAAA;AAEFJ,MAAM,CAACE,EAAE,CAAC,QAAQ,EAAE,CAACC,GAAG,EAAEC,KAAK,KAAI;EACjCzB,OAAO,CAACiB,IAAI,GAAGQ,KAAK,CAAA;EACpBzB,OAAO,CAACO,MAAM,GAAG,IAAI,CAAA;AACvB,CAAC,CAAC,CAAA;AAEFc,MAAM,CAACE,EAAE,CAAC,eAAe,EAAGC,GAAG,IAAI;EACjCxB,OAAO,CAACS,WAAW,GAAG,KAAK,CAAA;AAC7B,CAAC,CAAC,CAAA;AAEFY,MAAM,CAACE,EAAE,CAAC,MAAM,EAAE,MAAK;AACrBG,EAAAA,OAAO,CAACC,GAAG,CAACN,MAAM,CAACO,QAAQ,EAAE,CAAC,CAAA;AAC9B,EAAA,OAAO1B,OAAO,CAAC2B,IAAI,CAAC,CAAC,CAAC,CAAA;AACxB,CAAC,CAAC,CAAA;AAEFR,MAAM,CAACE,EAAE,CAAC,OAAO,EAAE,CAACC,GAAG,EAAEC,KAAK,KAAI;EAChC,IAAI,CAACA,KAAK,EAAE;AACVA,IAAAA,KAAK,GAAG,GAAG,CAAA;AACZ,GAAA;EACDzB,OAAO,CAACK,KAAK,GAAGoB,KAAK,CAAA;AACvB,CAAC,CAAC,CAAA;AAEFJ,MAAM,CAACE,EAAE,CAAC,MAAM,EAAE,CAACC,GAAG,EAAEC,KAAK,KAAI;EAC/BzB,OAAO,CAACe,IAAI,GAAGU,KAAK,CAAA;AACtB,CAAC,CAAC,CAAA;AAEFJ,MAAM,CAACE,EAAE,CAAC,SAAS,EAAE,CAACC,GAAG,EAAEC,KAAK,KAAI;AAClCzB,EAAAA,OAAO,CAACc,OAAO,CAACgB,IAAI,CAACL,KAAK,CAAC,CAAA;AAC7B,CAAC,CAAC,CAAA;AAEFJ,MAAM,CAACE,EAAE,CAAC,cAAc,EAAGC,GAAG,IAAI;EAChCxB,OAAO,CAACmB,WAAW,GAAG,IAAI,CAAA;AAC5B,CAAC,CAAC,CAAA;AAEFE,MAAM,CAACE,EAAE,CAAC,SAAS,EAAE,CAACC,GAAG,EAAEC,KAAK,KAAI;EAClCzB,OAAO,CAACoB,OAAO,GAAG,IAAI,CAAA;AACxB,CAAC,CAAC,CAAA;AAEFC,MAAM,CAACE,EAAE,CAAC,CAACC,GAAG,EAAEC,KAAK,KAAI;AACvBC,EAAAA,OAAO,CAACK,IAAI,EAAoBP,gBAAAA,EAAAA,GAAG,EAAE,CAAC,CAAA;AACxC,CAAC,CAAC,CAAA;AAEFH,MAAM,CAACW,KAAK,CAAC9B,OAAO,CAAC+B,IAAI,CAAC,CAAA;AAE1B,IAAI/B,OAAO,CAACgC,QAAQ,KAAK,OAAO,EAAE;AAChChC,EAAAA,OAAO,CAACqB,EAAE,CAAC,SAAS,EAAE,MAAMrB,OAAO,CAAC2B,IAAI,CAAC,CAAC,CAAC,CAAC,CAAA;AAC7C,CAAA;AAED,IAAI7B,OAAO,CAACO,MAAM,EAAE;AAClBmB,EAAAA,OAAO,CAACS,KAAK,CACX,mEAAmE,CACpE,CAAA;AACDT,EAAAA,OAAO,CAACS,KAAK,CAAC,uCAAuC,CAAC,CAAA;EACtDT,OAAO,CAACS,KAAK,CAAC,CAAA,aAAA,EAAgBnC,OAAO,CAACiB,IAAM,EAAA,CAAC,CAAA;EAC7CS,OAAO,CAACS,KAAK,CAAC,CAAA,OAAA,EAAUnC,OAAO,CAACiB,IAAM,EAAA,CAAC,CAAA;AACvCS,EAAAA,OAAO,CAACS,KAAK,CAAC,cAAc,CAAC,CAAA;AAC7BT,EAAAA,OAAO,CAACS,KAAK,CACX,oGAAoG,CACrG,CAAA;AACDjC,EAAAA,OAAO,CAAC2B,IAAI,CAAC,CAAC,CAAC,CAAA;AAChB,CAAA;AAED,MAAMO,KAAK,gBAAGC,OAAO,CACnB1B,SAAS,EACTX,OAAO,CAACC,OAAO,EACfD,OAAO,CAACS,WAAW,EACnBT,OAAO,CAACe,IAAI,EACZf,OAAO,CAACK,KAAK,CACd,CAAA;AAED,IAAIL,OAAO,CAACoB,OAAO,EAAE;AACnBM,EAAAA,OAAO,CAACC,GAAG,CAACS,KAAK,CAAChB,OAAO,CAAC,CAAA;AAC1BlB,EAAAA,OAAO,CAAC2B,IAAI,CAAC,CAAC,CAAC,CAAA;AAChB,CAAA;AAED,IAAI7B,OAAO,CAACmB,WAAW,EAAE;AACvBmB,EAAAA,WAAW,EAAE,CAAA;AACbZ,EAAAA,OAAO,CAACC,GAAG,CAAC,IAAI,CAAC,CAAA;AACjBzB,EAAAA,OAAO,CAAC2B,IAAI,CAAC,CAAC,CAAC,CAAA;AAChB,CAAA;AAEDO,KAAK,CAACG,IAAI,CAAC,qBAAqB,EAAE,MAAMH,KAAK,CAACI,GAAG,EAAE,CAAC,CAAA;AACpDJ,KAAK,CAACG,IAAI,CAAC,WAAW,EAAED,WAAW,CAAC,CAAA;AAEpC,SAASG,mBAAmBA,GAAA;AAC1B,EAAA,MAAMC,eAAe,GAAGC,OAAW,CAAC,GAAG,EAAE,uBAAuB,CAAC,CAAA;AAEjE,EAAA,IAAI,CAACC,EAAE,CAACC,UAAU,CAACH,eAAe,CAAC,EAAE;AACnC,IAAA,OAAA;AACD,GAAA;AAEDE,EAAAA,EAAE,CAACE,QAAQ,CACTJ,eAAe,EACf;AAAEK,IAAAA,QAAQ,EAAE,MAAA;AAAM,GAAE,EACpB,OAAOZ,KAAK,EAAEa,IAAY,KAAI;AAC5B,IAAA,IAAIb,KAAK,EAAE;AACT,MAAA,MAAMA,KAAK,CAAA;AACZ,KAAA;IAED,IAAI;MACF,MAAMC,KAAK,CAACK,mBAAmB,CAACQ,IAAI,CAACjB,KAAK,CAACgB,IAAI,CAAC,CAAC,CAAA;KAClD,CAAC,OAAOE,YAAY,EAAE;AACrBxB,MAAAA,OAAO,CAACS,KAAK,EAC4Ce,oDAAAA,EAAAA,YAAY,EAAE,CACtE,CAAA;AACDhD,MAAAA,OAAO,CAAC2B,IAAI,CAAC,CAAC,CAAC,CAAA;AAChB,KAAA;AACH,GAAC,CACF,CAAA;AACH,CAAA;AACA,SAASS,WAAWA,GAAA;EAClBF,KAAK,CAACe,IAAI,CAACR,OAAW,CAAC,GAAG,EAAE,SAAS,CAAC,CAAC,CAAA;EACvCP,KAAK,CAACe,IAAI,CAACR,OAAW,CAAC,GAAG,EAAE,KAAK,EAAE,SAAS,CAAC,CAAC,CAAA;AAE9CF,EAAAA,mBAAmB,EAAE,CAAA;AAErBzC,EAAAA,OAAO,CAACc,OAAO,CAACsC,OAAO,CAAEC,UAAU,IAAI;AACrC,IAAA,IAAIA,UAAU,CAAC,CAAC,CAAC,KAAK,GAAG,EAAE;AACzB,MAAA,OAAOjB,KAAK,CAACe,IAAI,CAACE,UAAU,CAAC,CAAA;AAC9B,KAAA;IAEDjB,KAAK,CAACe,IAAI,CAACR,OAAW,CAAC,GAAG,EAAEU,UAAU,CAAC,CAAC,CAAA;AAC1C,GAAC,CAAC,CAAA;AACJ"}